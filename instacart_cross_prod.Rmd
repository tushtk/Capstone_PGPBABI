---
title: "instacart_cross_prod_prep"
output:
  word_document: default
  pdf_document: default
  html_document: default
---
# Libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
#library(sqldf)
library(dplyr)
#library(reshape)
#library(arules)
```

# Read files
```{r}
O =fread("data/orders.csv")
O_T=fread("data/order_products__train.csv")
O_P=fread("data/order_products__prior.csv")
P = fread("data/products.csv")
D = fread("data/departments.csv")
A = fread("data/aisles.csv")
```

Total Orders - 32,14,874
Total customers - 2,06,209 = 7500(test) + 131209(train)

# Product file cleanup
```{r}
gsub("Constant Comment","",P$product_name) -> P$product_name
#grep("[\\]",P$product_name)
gsub('[\\]','',P$product_name) -> P$product_name
#grep("\"\"",P$product_name)
gsub("\"\"","",P$product_name) -> P$product_name
```

# Building train/test user set  
Find train user IDs to build train data;
```{r}
# train user set 
train_user <- as.matrix(unique(O[O$eval_set == "train",]$user_id))  
as.data.frame(train_user) ->train_user
names(train_user)  = "user_id"
# test user set 
test_user <- as.matrix(unique(O[O$eval_set == "test",]$user_id))  
as.data.frame(test_user) ->test_user
names(test_user)  = "user_id"

```

#sample it later
```{r}
#test/train sampling
#set.seed(1234)
#idx = sample(1:nrow(train_user),.7*nrow(train_user))
#train_user_sample = train_user[idx,]   # 91846 records
#test_user_sample = train_user[-idx,]   # 39363 records
```

#train_orders  # 15,24,629 orders  # 8547
#test_orders   # 6,53,957  orders  # 8128


# Extract complete order details;limit to 1000 users
```{r}

#print(paste("starting query" , Sys.time()))

train_user %>%
  head(100) %>% 
  left_join(O, by = "user_id") %>% 
  mutate(days_since_prior_order = ifelse(is.na(days_since_prior_order),
                                         0,days_since_prior_order)) %>% 
  mutate(cum_purchase_day =ave(days_since_prior_order,user_id,FUN=cumsum))  -> user_orders 
#colnames(prior_orders)[8] = "cum_purchase_day"

# Pick up the last 10 orders 
user_orders %>%
  group_by(user_id) %>%
  summarise(max_order_number = max(order_number)) ->user_max_order_number
user_orders %>% 
  left_join(user_max_order_number) ->user_orders
user_orders %>%
  filter(order_number + 10 >= max_order_number) ->user_orders_last10

# Merge with order_product_prior dataset 
user_orders_last10 %>% 
  left_join(O_P, by ="order_id") -> prior_orders


# Summarize at customer-product-level
prior_orders %>% 
  select(user_id,product_id,order_id,add_to_cart_order,days_since_prior_order,
         cum_purchase_day,order_dow,order_hour_of_day,
         cum_purchase_day ) %>%
  group_by(user_id,product_id ) %>% 
  mutate(prodPurch_lag = cum_purchase_day - lag(cum_purchase_day)) %>%
  mutate(prodPurch_lag = ifelse(is.na(prodPurch_lag),0,prodPurch_lag)) %>%
  summarise(prodPurchCount=n(),
            prodAddtocartOrder=round(median(add_to_cart_order)),
            prodPurch_lag = median(prodPurch_lag),
#            prodPurchDay  = mode(puchase_day),
#            prodPurchDOW  = mode(order_dow),
#            prodPurchHOD  = mode(order_hour_of_day),
            prodLastPurch = max(cum_purchase_day)) -> Cust_Prod_Feature

Cust_Prod_Feature %>% 
  mutate(prodNextPurch = prodLastPurch+ prodPurch_lag) ->Cust_Prod_Feature

```
# Extract future order details
```{r}
train_user %>% 
  left_join(O[O$eval_set=="train",]) ->Cust_future_orders

Cust_future_orders %>% 
  left_join(O_T) ->Cust_future_orders 
Cust_future_orders$reordered = Cust_future_orders$reordered +1 
paste0("FUT", colnames(Cust_future_orders))  -> colnames(Cust_future_orders)

colnames(Cust_future_orders)[1] = "user_id"
colnames(Cust_future_orders)[8] = "product_id"

Rem_cols = c("FUTeval_set","FUTorder_id")
Cust_future_orders[,!colnames(Cust_future_orders) %in% Rem_cols]-> Cust_future_orders
```

# *******   ***********   **********     ***********   **********    ***  ******# 
# Reduce the size to 100 customers 
```{r}
train_user[1:10000,] %>% as.data.frame()  ->users10
colnames(users10) <- "user_id"
# Merge customer, product CROSS PRODUCT to the future orders(determine reorders or NOT)

users10 %>% 
  left_join(Cust_Prod_Feature, all.x=TRUE) %>% 
  left_join(Cust_future_orders, all.x= TRUE)  ->Cust_future_orders_10


Cust_future_orders_10 %>% 
left_join(P, all.x= TRUE)  ->Cust_future_orders_10

Cust_future_orders_10  %>% 
  mutate(FUTreordered = ifelse(is.na(FUTreordered),0,1))-> Cust_Prod_cross_with_Y


length(unique(Cust_Prod_cross_with_Y$user_id))
#Cust_Prod_cross_with_Y[is.na(Cust_Prod_cross_with_Y$user_id),] %>% View()
```

# Extract purchase predictions(Y) for extracted users
```{r}

write.csv(Cust_Prod_cross_with_Y , "Cust_Prod_cross_with_Y_lmtd.csv")
```